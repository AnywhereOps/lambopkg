name: Autopromote

on:
  # schedule:
  #   - cron:  '30 16 * * *'
  workflow_dispatch:  # Enables manual triggering

permissions:
  contents: write
  id-token: write

jobs:
  autopromote:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      MUNKI_REPO: "AnywhereOps/munkisrv/munkirepo"

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: us-east-2

    - name: Fetch GitHub App secret
      uses: aws-actions/aws-secretsmanager-get-secrets@v2
      with:
        secret-ids: |
          MUNKISRV_APP, ${{ secrets.MUNKISRV_GITHUB_APP_ARN }}
        parse-json-secrets: true

    - name: Set Munki repo vars
      run: |
        echo "MUNKI_GH_REPO=$(echo $MUNKI_REPO | cut -d'/' -f1,2)" >> $GITHUB_ENV
        echo "MUNKI_CLONE_DIR=$(echo $MUNKI_REPO | cut -d'/' -f2)" >> $GITHUB_ENV
        SUBDIR=$(echo $MUNKI_REPO | cut -d'/' -f3-)
        echo "MUNKI_DIR=${GITHUB_WORKSPACE}/$(echo $MUNKI_REPO | cut -d'/' -f2)${SUBDIR:+/$SUBDIR}" >> $GITHUB_ENV

    - name: Checkout this repo
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #6.0.0
      with:
        fetch-depth: 1

    - name: Generate GitHub App token
      uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 #2.2.0
      id: app-token
      with:
        app-id: ${{ env.MUNKISRV_APP_APP_ID }}
        private-key: ${{ env.MUNKISRV_APP_PRIVATE_KEY }}
        owner: AnywhereOps

    - name: Checkout Munki repo
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 #6.0.0
      with:
        repository: ${{ env.MUNKI_GH_REPO }}
        token: ${{ steps.app-token.outputs.token }}
        fetch-depth: 1
        path: ${{ env.MUNKI_CLONE_DIR }}

    - name: Configure Munki repo push credentials
      run: |
        cd ${{ env.MUNKI_CLONE_DIR }}
        git remote set-url origin "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${{ env.MUNKI_GH_REPO }}.git"

    - name: Disable makecatalogs
      run: |
        echo -e "#!/bin/bash\necho 'makecatalogs disabled'" >> ~/makecatalogs
        sudo install -D -m 777 ~/makecatalogs /usr/local/munki/makecatalogs

    - name: Configure autopromote
      run: |
        sudo cp autopromote.json /usr/local/munki/autopromote.json
        echo "export SLACK_TOKEN='${{ secrets.AUTOPROMOTE_SLACK_TOKEN }}'" >> ~/.autopromote.env
        sudo install -m 644 /dev/null /var/log/autopromote.log
        sudo ln -s "${MUNKI_DIR}" /usr/local/munkirepo

    - name: Set up the environment
      uses: ./.github/actions/setup-python-env

    - name: Run autopromote
      run: |
        uv run lambopkg/runners/autopromote.py
      env:
        SLACK_TOKEN: ${{ secrets.AUTOPROMOTE_SLACK_TOKEN }}

    - name: Push changes
      run: |
        cd ${{ env.MUNKI_CLONE_DIR }}
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git checkout -b "autopromote-$(date +'%Y-%m-%d')"
        git add pkgsinfo/
        if ! git diff --staged --quiet; then
          git commit -m "$(date +'%Y-%m-%d') autopromote"
          git push --set-upstream origin "autopromote-$(date +'%Y-%m-%d')"
        else
          echo "Nothing to commit"
        fi
